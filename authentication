var CLIENT_ID = '181FE9A6B15E4B729988987Bxxxxxxxx';
var CLIENT_SECRET = 'm4qg0mZK7yz8TBOwpkpDKsRRdFdj_xxxxxxxxxxxx';
var XERO_TENANT_ID = '136def1d-8ed0-405c-8fbd-xxxxxxxxx';

var redirect_uri = OAuth2.getRedirectUri()
// Logger.log(redirect_uri);


var options = {
  'grant-type': 'authorization_code',
  'redirect-uri': redirect_uri,
  'content-type': 'application/x-www-form-urlencoded',
  'code': 'dfd1c90a04dca24af48d6782079a859c1d4fd09d5b1934axxxxxxxxxxx'
};


// Authorise request to Xero //

function getAuth () {
  var service = getService();
  if (service.hasAccess()) {
    var url = 'https://api.xero.com/payroll.xro/2.0/employees';
    var response = UrlFetchApp.fetch(url, {muteHttpExceptions: true,
      headers: {
        'authorization': 'Bearer ' + service.getAccessToken(),
        'payload' : options,
        'Xero-Tenant-Id' : XERO_TENANT_ID
      }
    });
    var result = JSON.parse(response.getContentText());
    Logger.log(JSON.stringify(result, null, 2));
  } else {
    var authorizationUrl = service.getAuthorizationUrl();
    Logger.log('Open the following URL and re-run the script: %s',authorizationUrl);
  }
}


// Call the API //

function apiCall () {
  var url = 'https://api.xero.com/payroll.xro/2.0/Employees';
  var response = UrlFetchApp.fetch(url, {
      headers: {
        Accept: application/json,
        Xero_tenant_id: XERO_TENANT_ID,
        Grant_type: 'authorization_code',
        Authorization: 'Bearer ' + access_token
      }
    });
    var result = JSON.parse(response.getContentText());
    Logger.log(JSON.stringify(result, null, 2));
}


// Service Configuration //

function getService() {
  return OAuth2.createService('Xero Testing')
      .setAuthorizationBaseUrl('https://login.xero.com/identity/connect/authorize')
      .setTokenUrl('https://identity.xero.com/connect/token')
      .setClientId(CLIENT_ID)
      .setClientSecret(CLIENT_SECRET)
      .setCallbackFunction('authCallback')
      .setPropertyStore(PropertiesService.getUserProperties())
      .setScope('payroll.employees')
}


// Auth Callback //

function authCallback(request) {
  var service = getService();
  var authorized = service.handleCallback(request);
  if (authorized) {
    return HtmlService.createHtmlOutput('Success!');
  } else {
    return HtmlService.createHtmlOutput('Denied.');
  }
}


// Check token API tenant connections //

function connections () {
var service = getService();
var getConnections  = UrlFetchApp.fetch('https://api.xero.com/connections', {
      headers: {
        Authorization: 'Bearer ' + service.getAccessToken(),
        Content_Type: 'application/json'
       }});
    Logger.log (getConnections);
}





